name: CD
on:
  workflow_dispatch:
jobs:
  deploy:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¾ Checkout Repo
        uses: actions/checkout@v4
      - name: ğŸ“¦ Install Dependencies
        run: npm install
      - name: ğŸ› ï¸ Build React App
        run: npm run build
      - name: ğŸšš SCP Build Folder to VPS Temp Location
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AZURE_VM_IP }}
          username: azureuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "build/*"
          target: "/tmp/react-build"
      - name: ğŸš€ Deploy Build to Nginx Directory
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.AZURE_VM_IP }}
          username: azureuser
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            echo "ğŸ“ Checking /var/www/react-app existence..."
            if [ ! -d /var/www/react-app ]; then
              echo "ğŸ“‚ Creating /var/www/react-app..."
              sudo mkdir -p /var/www/react-app
              sudo chown azureuser:azureuser /var/www/react-app
            fi
            echo "ğŸ§¹ Cleaning old build..."
            sudo rm -rf /var/www/react-app/*
            echo "ğŸ“¦ Moving new build to /var/www/react-app..."
            sudo mv /tmp/react-build/* /var/www/react-app/
            echo "âœ… Build deployed to /var/www/react-app"
            echo "ğŸ” Reloading Nginx (if needed)..."
            sudo systemctl reload nginx || echo "âš ï¸ Nginx reload failed or not required"